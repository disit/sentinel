{% extends "main.html" %}
{% block title %}Snap4Sentinel{% endblock %}
{% block head %}
{{ super() }}
{% endblock %}
{% block content %}
<table id="containers">
  <thead>
	  <tr>
		<th>Container</th>
		<th>Category</th>
		<th>Contacts</th>
		<th>Position</th>
		<th>Kind</th>
		<th>Delete</th>
		<th>Edit</th>
	  </tr>
  </thead>
  <tbody>
{%for item in containers%}
    <tr>
	  <td>{{item[0]}}</td>
	  <td>{{item[1]}}</td>
	  <td>{{item[2]}}</td>
	  <td>{{item[3]}}</td>
	  <td>{{item[4]}}</td>
	  <td><button type="button" class="btn btn-primary open-modal-m" data-toggle="modal" data-target="#deleteComponent" data-component="{{item[0]}}" id="deleteComponent{{item[0]}}" onClick="$('#addComponentModal').modal('hide')">Delete</button></td>
	  <td><button type="button" class="btn btn-primary open-modal-e" data-toggle="modal" data-target="#editComponent" data-component="{{item[0]}}" data-category="{{item[1] | e}}" data-contacts="{{item[2] | e}}" data-position="{{item[3] | e}}" data-kind="{{item[4] | e}}" id="editComponent{{item[0]}}" onClick="$('#addComponentModal').modal('hide')">Edit</button></td>
	</tr>
{% endfor %}
  </tbody>
</table>
<button type="button" class="btn btn-primary open-modal" data-toggle="modal" data-target="#addComponentModal" id="addComponent">Add</button>
<div class="modal fade" id="addComponentModal" tabindex="-1" role="dialog" aria-labelledby="addComponentModal" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="addComponentLabel">Add a new container</h5>
				<button type="button" class="btn btn-danger" data-dismiss="modal" aria-label="Close" style="position: absolute; right: 15px;" onClick="$('#addComponentModal').modal('hide')">
					<span aria-hidden="true">X</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="addComponentForm">
					<div class="form-group">
						<label for="passwordInputAdd">Password</label>
						<input type="password" class="form-control" id="passwordInputAdd" autocomplete="current-password" required>
					</div>
					<div class="form-group">
						<label for="containeridmodalAdd">Container ID</label>
						<input type="text" class="form-control" id="containeridmodalAdd" required>
					</div>
					<div id="containerextradetailsAdd" class="form-text">End the string with an asterisk (*) to match all which starts with string behind asterisk</div>
					<label for="category-selection">Select category:</label>
					<select id="category-selection" name="category-selection" class="form-select">
						{%for item in categories %}
							<option value="{{item[0]}}">{{item[0]}}</option>
						{% endfor %}
					</select>
					<div class="form-group">
						<label for="ContactsAdd">Contacts</label>
						<input type="text" class="form-control" id="ContactsAdd" required>
					</div>
					<div class="form-group">
						<label for="PositionAdd">Position</label>
						<input type="text" class="form-control" id="PositionAdd" placeholder="Address of the Snap4Sentinel instance's host which holds the container" required>
					</div>
					<div class="form-group">
						<label for="NamespaceAdd">Namespace (ignored when kind isn't docker)</label>
						<input type="text" class="form-control" id="NamespaceAdd" required>
					</div>
					<label for="kind-selection">Select container kind:</label>
					<select id="kind-selection" name="kind-selection" class="form-select">
						<option value="docker">Docker</option>
						<option value="kubernetes">Kubernetes</option>
					</select>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn close btn-secondary" data-dismiss="modal" aria-label="Close" onClick="$('#addComponentModal').modal('hide')">Close</button>
				<button type="button" class="btn btn-primary" data-dismiss="modal" id="addContainerButton">Add container</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="editComponent" tabindex="-1" role="dialog" aria-labelledby="editComponent" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="editComponentLabel">Edit container</h5>
				<button type="button" class="btn btn-danger" data-dismiss="modal" aria-label="Close" style="position: absolute; right: 15px;" onClick="$('#editComponentModal').modal('hide')">
					<span aria-hidden="true">X</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="editComponentForm">
					<div class="form-group">
						<label for="passwordInputEdit">Password</label>
						<input type="password" class="form-control" id="passwordInputEdit" autocomplete="current-password" required>
					</div>
					<div class="form-group">
						<label for="containeridmodalEdit">Container ID</label>
						<input type="text" class="form-control" id="containeridmodalEdit" required readonly>
					</div>
					<div id="containerextradetailsEdit" class="form-text">End the string with an asterisk (*) to match all which starts with string behind asterisk</div>
					<label for="category-selection-edit">Select category:</label>
					<select id="category-selection-edit" name="category-selection-edit" class="form-select">
						{% for item in categories %}
							<option value="{{item[0]}}">{{item[0]}}</option>
						{% endfor %}
					</select>
					<div class="form-group">
						<label for="ContactsEdit">Contacts</label>
						<input type="text" class="form-control" id="ContactsEdit" required>
					</div>
					<div class="form-group">
						<label for="PositionEdit">Position</label>
						<input type="text" class="form-control" id="PositionEdit" placeholder="Address of the Snap4Sentinel instance's host which holds the container" required>
					</div>
					<div class="form-group">
						<label for="NamespaceEdit">Namespace (ignored when kind isn't docker)</label>
						<input type="text" class="form-control" id="NamespaceEdit" required>
					</div>
					<label for="kind-selection-edit">Select container kind:</label>
					<select id="kind-selection-edit" name="kind-selection-edit" class="form-select">
						<option value="docker">Docker</option>
						<option value="kubernetes">Kubernetes</option>
					</select>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal" aria-label="Close" onClick="$('#editComponentModal').modal('hide')">Cancel</button>
				<button type="button" class="btn btn-success" data-dismiss="modal" id="saveComponentChangesButton">Save changes</button>
			</div>
		</div>
	</div>
</div>


<div class="modal fade" id="deleteComponent" tabindex="-1" role="dialog" aria-labelledby="deleteComponentLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="deleteComponentLabel">Confirmation for deleting component</h5>
				<button type="button" class="btn btn-danger" data-dismiss="modal" aria-label="Close" style="position: absolute; right: 15px;" onClick="$('#deleteComponent').modal('hide')">
					<span aria-hidden="true">X</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="deleteComponentForm">
					<div class="form-group">
						<label for="passwordInputDelete">Password</label>
						<input type="password" class="form-control" id="passwordInputDelete" autocomplete="current-password" required>
					</div>
					<div class="form-group">
						<label for="componentDeleteId">Container ID</label>
						<input type="text" class="form-control" id="componentDeleteId" readonly>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn close btn-secondary" data-dismiss="modal" aria-label="Close">Close</button>
				<button type="button" class="btn btn-primary" data-dismiss="modal" id="deleteComponentButton" onClick="$('#deleteComponent').modal('hide')">Delete Component</button>
			</div>
		</div>
	</div>
</div>
<script>
	    document.addEventListener('DOMContentLoaded', () => {
        // 1. Get the 'value' from the URL query parameters
        const urlParams = new URLSearchParams(window.location.search);
        const targetValue = urlParams.get('container_id');

        // 2. Only proceed if the parameter 'value' is actually present
        if (targetValue) {
            // 3. Construct the selector for class "thisclass" and attribute "thisattribute"
            const selector = `.open-modal-e[data-component="${targetValue}"]`;
            const button = document.querySelector(selector);

            if (button) {
            button.click();
            } else {
			alert(`Precise container not found, this is likely due to kubernetes not having guaranteed names, try look for something which starts with "${targetValue}"`);
            console.warn(`Element not found for selector: ${selector}`);
            }
        }
        
		$("#containers").DataTable();
        });
	$('.open-modal-m').on('click', function() {
		var id = $(this).data('component');
		$('#componentDeleteId').val(id);
		$('#deleteComponent').modal('show');
	});
	$('.open-modal-e').on('click', function() {
		var id = $(this).data('component');
		var category = $(this).data('category');
		var kind = $(this).data('kind');
		var position = $(this).data('position');
		var contacts = $(this).data('contacts');
		$('#PositionEdit').val(position);
		$('#ContactsEdit').val(contacts);
		$('#containeridmodalEdit').val(id);
		let select = document.getElementById('category-selection-edit');
		let select_k = document.getElementById('kind-selection-edit');

		for (let i = 0; i < select.options.length; i++) {
			if (select.options[i].text === category) {
				select.selectedIndex = i;
				break;
			}
		}
		for (let i = 0; i < select_k.options.length; i++) {
			if (select_k.options[i].text === kind) {
				select_k.selectedIndex = i;
				break;
			}
		}
		$('#editComponent').modal('show');
	});
	$('.open-modal').on('click', function() {
		$('#addComponentModal').modal('show');
	});
	$('#deleteComponentButton').on('click', function() {
		var password = $('#passwordInputDelete').val();
		var id = $('#componentDeleteId').val();
		if (password) {
			try {
				$.ajax({
					url: './delete_container',
					data: {id: id, psw: password},
					type: 'POST',
					success: function(response) {
						alert(id + " was deleted!");
						location.reload();
					},
					error: function(error) {
						alert(id + " was not deleted because of: " + error);
					},
					timeout: {{timeout}}
				});
			}
			catch (exception_var) {
				console.log(exception_var);
			}
		}
		else {
			alert('Please enter a password');
		}
	});
	$('#addContainerButton').on('click', function() {
		var password = $('#passwordInputAdd').val();
		var id = $('#containeridmodalAdd').val();
		var category = $('#category-selection').val();
		var kind = $('#kind-selection').val();
		var contacts = $('#ContactsAdd').val();
		var position = $('#PositionAdd').val();
		var namespace = $('#NamespaceAdd').val();
		if (password) {
			try {
				$.ajax({
					url: './add_container',
					data: {id: id, psw: password, category: category, contacts: contacts, position: position, kind: kind, namespace: namespace},
					type: 'POST',
					success: function(response) {
						alert(id + " was added!");
						location.reload();
					},
					error: function(error) {
						alert(id + " was not added because of: " + error);
					},
					timeout: {{timeout}}
				});
			}
			catch (exception_var) {
				console.log(exception_var);
			}
		}
		else {
			alert('Please enter a password');
		}
	});
	$('#saveComponentChangesButton').on('click', function() {
	var password = $('#passwordInputEdit').val();
	var id = $('#containeridmodalEdit').val();
	var category = $('#category-selection-edit').val();
	var kind = $('#kind-selection-edit').val();
	var contacts = $('#ContactsEdit').val();
	var position = $('#PositionEdit').val();
	var namespace = $('#NamespaceEdit').val();
	if (password) {
		try {
			$.ajax({
				url: './edit_container',
				data: {id: id, psw: password, category: category, contacts: contacts, kind: kind, position: position, namespace: namespace},
				type: 'POST',
				success: function(response) {
					alert(id + " was edited!");
					location.reload();
				},
				error: function(error) {
					alert(id + " was not edited because of: " + error.responseText);
				},
				timeout: {{timeout}}
			});
		}
		catch (exception_var) {
			console.log(exception_var);
		}
	}
	else {
		alert('Please enter a password');
	}
	});
</script>
{% endblock %}